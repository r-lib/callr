<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Persistent External R Sessions • callr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Persistent External R Sessions">
<meta name="robots" content="noindex">
<script defer data-domain="callr.r-lib.org,all.tidyverse.org" src="https://plausible.io/js/plausible.js"></script>
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">callr</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="In-development version">3.7.6.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><h6 class="dropdown-header" data-toc-skip>Tutorials</h6></li>
    <li><a class="dropdown-item" href="../articles/r-session.html">Persistent R sessions</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Blog posts</h6></li>
    <li><a class="external-link dropdown-item" href="https://www.tidyverse.org/blog/2019/09/callr-task-q">A multi process task queue in 100 lines of R code</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/r-lib/callr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Persistent External R Sessions</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/callr/blob/main/vignettes/r-session.Rmd" class="external-link"><code>vignettes/r-session.Rmd</code></a></small>
      <div class="d-none name"><code>r-session.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code><a href="../reference/r_session.html">callr::r_session</a></code> is a class for a persistent R session
that runs in the background and you can send commands to it. It extends
the <code><a href="http://processx.r-lib.org/reference/process.html" class="external-link">processx::process</a></code> class, so all methods of that class
are still available for use.</p>
</div>
<div class="section level2">
<h2 id="starting-and-terminating-an-r-session">Starting and terminating an R session<a class="anchor" aria-label="anchor" href="#starting-and-terminating-an-r-session"></a>
</h2>
<p>Use <code>r_session$new()</code> to start an R session. By default
<code>r_session$new()</code> blocks, it does not return until the R
session is up and running and ready to run R commands. If an error
happens during process startup, including an R error, then
<code>r_session$new()</code> throws an error. A blocking
<code>r_session$new()</code> waits at most <code>wait_timeout</code>
milliseconds for R to start up. <code>wait_timeout</code> is by default
3000 milliseconds, which should be plenty. Typically R starts up in
about 100-300 milliseconds.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://callr.r-lib.org">callr</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt;    user  system elapsed                                                         
#&gt;   0.014   0.002   0.180                                                         
</pre>
</div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; R SESSION, alive, idle, pid 9941.                                               
</pre>
</div>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [1] "idle"                                                                      
</pre>
</div>
<p>To terminate an R session, call its <code>$close()</code> method:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span><span class="op">$</span><span class="fu">close</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rs</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; R SESSION, finished, pid 9941.                                                  
</pre>
</div>
<p>Just like <code><a href="http://processx.r-lib.org/reference/process.html" class="external-link">processx::process</a></code> objects,
<code>r_session</code> objects have a finalizer, and they will be
terminated when the R object that represents them is garbage
collected.</p>
<div class="section level3">
<h3 id="non-blocking-startup">Non-blocking startup<a class="anchor" aria-label="anchor" href="#non-blocking-startup"></a>
</h3>
<p>If you don’t want to wait for the session to start up, then use
<code>wait = FALSE</code> in <code>r_session$new()</code>. If you do
that, <code>r_session$new()</code> will still error if the OS cannot
start up the R process, but R errors will be reported
asynchronously.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/system.time.html" class="external-link">system.time</a></span><span class="op">(</span><span class="va">rs2</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>wait <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt;    user  system elapsed                                                         
#&gt;   0.002   0.002   0.007                                                         
</pre>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs2</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; R SESSION, alive, starting, pid 9952.                                           
</pre>
</div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs2</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [1] "starting"                                                                  
</pre>
</div>
<p>You can use <code><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">processx::poll()</a></code> to wait for the R session
being ready, with a timeout. The timeout can also be 0ms for a quick
check without waiting. This lets you do extra work in the main process
while the R process is starting up. It also lets you start up multiple
processes concurrently, see the next section.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">processx</span><span class="fu">::</span><span class="fu"><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">poll</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">rs2</span><span class="op">)</span>, <span class="fl">3000</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [[1]]                                                                           
#&gt;   output    error  process                                                      
#&gt; "silent" "silent"  "ready"                                                      
#&gt;                                                                                 
</pre>
</div>
<p>The important part of the output is the <code>process</code>
connection. This will be <code>"ready"</code> if the R process is up and
running, or if an error happened. It will be <code>"timeout"</code> if
it is not yet ready.</p>
<p><code>output</code> and <code>error</code> will be
<code>"ready"</code> if the R process emitted something to its standard
output and standard error, respectively. Usually these will be
<code>"silent"</code> because we suppress R output during startup with
command line options. This can be changed via the <code>options</code>
argument and <code><a href="../reference/r_session_options.html">r_session_options()</a></code>.</p>
<p>Once <code><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">processx::poll()</a></code> reports a <code>"ready"</code>
<code>process</code> connection, you can call the
<code>r_session$read()</code> method to see if the startup was
successful.</p>
<p>If <code>r_session$$read()</code> reports “201 STARTED”, it is ready
to run R code:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs2</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; $code                                                                           
#&gt; [1] 201                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "ready to go"                                                               
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
</pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="options">Options<a class="anchor" aria-label="anchor" href="#options"></a>
</h2>
<p>You can use the <code>options</code> argument of
<code>r_session$new()</code> to change the default startup options.
<code>options</code> must be a named list and it is best to create its
value with <code><a href="../reference/r_session_options.html">r_session_options()</a></code>. Pass the options you want
to change as named arguments to <code><a href="../reference/r_session_options.html">r_session_options()</a></code>. See
<code><a href="../reference/r_session_options.html">?r_session_options</a></code> for the details.</p>
<p>Here is an example that uses the <code>load_hook</code> option to run
extra code right after R has started up:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/r_session_options.html">r_session_options</a></span><span class="op">(</span></span>
<span>  load_hook <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="op">{</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"I am running!"</span><span class="op">)</span>; <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">rs3</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>wait <span class="op">=</span> <span class="cn">FALSE</span>, options <span class="op">=</span> <span class="va">opts</span><span class="op">)</span></span>
<span><span class="fu">processx</span><span class="fu">::</span><span class="fu"><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">poll</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">rs3</span><span class="op">)</span>, <span class="fl">3000</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [[1]]                                                                           
#&gt;   output    error  process                                                      
#&gt; "silent"  "ready" "silent"                                                      
#&gt;                                                                                 
</pre>
</div>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs3</span><span class="op">$</span><span class="fu">read_error</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [1] "I am running!\n"                                                           
</pre>
</div>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs3</span><span class="op">$</span><span class="fu">poll_process</span><span class="op">(</span><span class="fl">3000</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [1] "ready"                                                                     
</pre>
</div>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs3</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; $code                                                                           
#&gt; [1] 201                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "ready to go"                                                               
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
</pre>
</div>
<p>Use the <code>$poll_process()</code> method to poll only the process
for being ready, without polling the standard output and error. Note,
however, that if the process generates enough output on stdout or stderr
that fills the pipe buffer between the processes, then it will stop
running, until the main process reads the pipe.</p>
</div>
<div class="section level2">
<h2 id="running-multiple-r-sessions">Running multiple R sessions<a class="anchor" aria-label="anchor" href="#running-multiple-r-sessions"></a>
</h2>
<p>If you need to start several R sessions quickly, then it is best to
use <code>wait = FALSE</code> and then <code><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">processx::poll()</a></code> for
all processes until they are all ready.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">num_procs</span> <span class="op">&lt;-</span> <span class="fl">4</span></span>
<span><span class="va">procs</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble</a></span><span class="op">(</span></span>
<span>  session <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="va">num_procs</span>, <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span>wait <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>  started_at <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  start_result <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="va">limit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">as.difftime</a></span><span class="op">(</span><span class="fl">5</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span><span class="kw">while</span> <span class="op">(</span><span class="op">(</span><span class="va">now</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">limit</span> <span class="op">&amp;&amp;</span></span>
<span>       <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">procs</span><span class="op">$</span><span class="va">session</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="va">p</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span>, <span class="st">""</span><span class="op">)</span> <span class="op">==</span> <span class="st">"starting"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">timeout</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">limit</span> <span class="op">-</span> <span class="va">now</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span>  <span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu">processx</span><span class="fu">::</span><span class="fu"><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">poll</a></span><span class="op">(</span><span class="va">procs</span><span class="op">$</span><span class="va">session</span>, <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">timeout</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">pr</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">pr</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"process"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">"ready"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">procs</span><span class="op">$</span><span class="va">start_result</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;&lt;-</span> <span class="va">procs</span><span class="op">$</span><span class="va">session</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">procs</span><span class="op">$</span><span class="va">started_at</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; Time differences in secs                                                        
#&gt; [1] 0.292556 0.292556 0.292556 0.292556                                         
</pre>
</div>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">procs</span><span class="op">$</span><span class="va">start_result</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [[1]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 201                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "ready to go"                                                               
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
#&gt; [[2]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 201                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "ready to go"                                                               
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
#&gt; [[3]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 201                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "ready to go"                                                               
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
#&gt; [[4]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 201                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "ready to go"                                                               
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
</pre>
</div>
</div>
<div class="section level2">
<h2 id="running-code">Running code<a class="anchor" aria-label="anchor" href="#running-code"></a>
</h2>
<p><code>r_session</code> objects have three methods to run R code:</p>
<ul>
<li>
<code>$run()</code> is synchronous and omits standard output and
error.</li>
<li>
<code>$run_with_output()</code> is synchronous and collects standard
output and error.</li>
<li>
<code>$call()</code> is asynchronous and collects standard output
and error.</li>
</ul>
<p>Let’s use the 4 R sessions created above to demonstrate them.</p>
<p><code>$run()</code> is the simplest:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">procs</span><span class="op">$</span><span class="va">session</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"I am process {Sys.getpid()}."</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; I am process 9972.                                                              
</pre>
</div>
<p><code>$run_with_output()</code> has the output as well:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">procs</span><span class="op">$</span><span class="va">session</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">run_with_output</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"I am process "</span>, <span class="fu"><a href="https://rdrr.io/r/base/Sys.getpid.html" class="external-link">Sys.getpid</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"."</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; $code                                                                           
#&gt; [1] 200                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "done callr-rs-result-26cc21813598"                                         
#&gt;                                                                                 
#&gt; $result                                                                         
#&gt;                    mpg cyl disp  hp drat    wt  qsec vs am gear carb            
#&gt; Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4            
#&gt; Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4            
#&gt; Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1            
#&gt; Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1            
#&gt; Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2            
#&gt; Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1            
#&gt;                                                                                 
#&gt; $stdout                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $stderr                                                                         
#&gt; [1] "I am process 9972.\n"                                                      
#&gt;                                                                                 
#&gt; $error                                                                          
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
</pre>
</div>
<p><code>$call()</code> starts running the function, but does not wait
for the result:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">procs</span><span class="op">$</span><span class="va">session</span>, <span class="kw">function</span><span class="op">(</span><span class="va">p</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">p</span><span class="op">$</span><span class="fu">call</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/Sys.sleep.html" class="external-link">Sys.sleep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span> <span class="op">*</span> <span class="fl">2</span><span class="op">)</span></span>
<span>      <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html" class="external-link">glue</a></span><span class="op">(</span><span class="st">"I am process {Sys.getpid()}."</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">procs</span><span class="op">$</span><span class="va">session</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [[1]]                                                                           
#&gt; R SESSION, alive, busy, pid 9972.                                               
#&gt;                                                                                 
#&gt; [[2]]                                                                           
#&gt; R SESSION, alive, busy, pid 9974.                                               
#&gt;                                                                                 
#&gt; [[3]]                                                                           
#&gt; R SESSION, alive, busy, pid 9979.                                               
#&gt;                                                                                 
#&gt; [[4]]                                                                           
#&gt; R SESSION, alive, busy, pid 9984.                                               
#&gt;                                                                                 
</pre>
</div>
<p>Use <code><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">processx::poll()</a></code> to wait for one or more sessions to
finish their job:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu">processx</span><span class="fu">::</span><span class="fu"><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">poll</a></span><span class="op">(</span><span class="va">procs</span><span class="op">$</span><span class="va">session</span>, <span class="fl">5000</span><span class="op">)</span></span>
<span><span class="va">pr</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [[1]]                                                                           
#&gt;   output    error  process                                                      
#&gt; "silent" "silent"  "ready"                                                      
#&gt;                                                                                 
#&gt; [[2]]                                                                           
#&gt;   output    error  process                                                      
#&gt; "silent" "silent" "silent"                                                      
#&gt;                                                                                 
#&gt; [[3]]                                                                           
#&gt;   output    error  process                                                      
#&gt; "silent" "silent" "silent"                                                      
#&gt;                                                                                 
#&gt; [[4]]                                                                           
#&gt;   output    error  process                                                      
#&gt; "silent" "silent" "silent"                                                      
#&gt;                                                                                 
</pre>
</div>
<p>Then you can use the <code>$read()</code> method to read out the
result (or error, if a failure happened):</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">pr</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">pr</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"process"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">"ready"</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/cat.html" class="external-link">cat</a></span><span class="op">(</span><span class="st">"Process "</span>, <span class="va">i</span>, <span class="st">" is ready:\n"</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">procs</span><span class="op">$</span><span class="va">session</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; Process  1  is ready:                                                           
#&gt; $code                                                                           
#&gt; [1] 200                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "done callr-rs-result-26cc35953699"                                         
#&gt;                                                                                 
#&gt; $result                                                                         
#&gt; I am process 9972.                                                              
#&gt;                                                                                 
#&gt; $stdout                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $stderr                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $error                                                                          
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
</pre>
</div>
<p>To wait for all processes to be ready, you can use a loop that is
similar to the one we used above to start them. You might find this
helper function useful as a starting point:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">wait_for_sessions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">sess</span>, <span class="va">timeout</span> <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">result</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/vector.html" class="external-link">vector</a></span><span class="op">(</span><span class="st">"list"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">sess</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">is_busy</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">sess</span>, <span class="kw">function</span><span class="op">(</span><span class="va">s</span><span class="op">)</span> <span class="va">s</span><span class="op">$</span><span class="fu">get_state</span><span class="op">(</span><span class="op">)</span> <span class="op">==</span> <span class="st">"busy"</span>, <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">logical</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">limit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/difftime.html" class="external-link">as.difftime</a></span><span class="op">(</span><span class="va">timeout</span> <span class="op">/</span> <span class="fl">1000</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span></span>
<span>  <span class="kw">while</span> <span class="op">(</span><span class="op">(</span><span class="va">now</span> <span class="op">&lt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Sys.time.html" class="external-link">Sys.time</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="va">limit</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">busy</span> <span class="op">&lt;-</span> <span class="fu">is_busy</span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">towait</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/double.html" class="external-link">as.double</a></span><span class="op">(</span><span class="va">limit</span> <span class="op">-</span> <span class="va">now</span>, units <span class="op">=</span> <span class="st">"secs"</span><span class="op">)</span> <span class="op">*</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>    <span class="va">pr</span> <span class="op">&lt;-</span> <span class="fu">processx</span><span class="fu">::</span><span class="fu"><a href="http://processx.r-lib.org/reference/poll.html" class="external-link">poll</a></span><span class="op">(</span><span class="va">sess</span><span class="op">[</span><span class="va">busy</span><span class="op">]</span>, <span class="va">towait</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">pr</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">pr</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">[[</span><span class="st">"process"</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="st">"ready"</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">result</span><span class="op">[</span><span class="va">busy</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">sess</span><span class="op">[</span><span class="va">busy</span><span class="op">]</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">result</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">wait_for_sessions</span><span class="op">(</span><span class="va">procs</span><span class="op">$</span><span class="va">session</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [[1]]                                                                           
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; [[2]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 200                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "done callr-rs-result-26cc3a4281fe"                                         
#&gt;                                                                                 
#&gt; $result                                                                         
#&gt; I am process 9974.                                                              
#&gt;                                                                                 
#&gt; $stdout                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $stderr                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $error                                                                          
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
#&gt; [[3]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 200                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "done callr-rs-result-26cc55ae7679"                                         
#&gt;                                                                                 
#&gt; $result                                                                         
#&gt; I am process 9979.                                                              
#&gt;                                                                                 
#&gt; $stdout                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $stderr                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $error                                                                          
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
#&gt; [[4]]                                                                           
#&gt; $code                                                                           
#&gt; [1] 200                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "done callr-rs-result-26cc6b08a2ca"                                         
#&gt;                                                                                 
#&gt; $result                                                                         
#&gt; I am process 9984.                                                              
#&gt;                                                                                 
#&gt; $stdout                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $stderr                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $error                                                                          
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
#&gt;                                                                                 
</pre>
</div>
<p>Errors from a <code>$run()</code> are turned into errors in the main
process:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rs</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"not-a-package"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span>:                                                                          
#&gt; <span style="color: #B58900;">!</span> in callr subprocess.                                                          
#&gt; <span style="font-weight: bold;">Caused by error</span> in `library("not-a-package")`:                                  
#&gt; <span style="color: #B58900;">!</span> there is no package called ‘not-a-package’                                    
#&gt; <span style="color: #525252;">Type .Last.error to see the more details.</span>                                       
</pre>
</div>
<p>callr also adds two stack traces to the output, one for the main
process and one for the subprocess:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.Last.error</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; <span style="color: #268BD2;">&lt;callr_error/rlib_error_3_0/rlib_error/error&gt;</span>                                   
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span>:                                                                          
#&gt; <span style="color: #B58900;">!</span> in callr subprocess.                                                          
#&gt; <span style="font-weight: bold;">Caused by error</span> in `library("not-a-package")`:                                  
#&gt; <span style="color: #B58900;">!</span> there is no package called ‘not-a-package’                                    
#&gt; ---                                                                             
#&gt; Backtrace:                                                                      
#&gt; <span style="color: #525252;">1. </span>rs<span style="color: #cc9900;">$</span><span style="font-weight: bold;">run</span><span style="color: #cc9900;">(</span><span style="color: #999900;">function</span><span style="color: #B58900;">()</span> <span style="font-weight: bold;">library</span><span style="color: #B58900;">(</span><span style="color: #009999;">"not-a-package"</span><span style="color: #B58900;">)</span><span style="color: #cc9900;">)</span>                                  
#&gt; <span style="color: #525252;">2. </span>callr:::<span style="font-weight: bold;">rs_run</span><span style="color: #cc9900;">(</span>self, private, func, args, package<span style="color: #cc9900;">)</span>                           
#&gt; <span style="color: #525252;">3. </span>callr:::<span style="font-weight: bold;">throw</span><span style="color: #cc9900;">(</span>res<span style="color: #cc9900;">$</span>error<span style="color: #cc9900;">)</span>                                                     
#&gt; ---                                                                             
#&gt; Subprocess backtrace:                                                           
#&gt; <span style="color: #525252;">1. </span>base::<span style="font-weight: bold;">library</span><span style="color: #cc9900;">(</span><span style="color: #009999;">"not-a-package"</span><span style="color: #cc9900;">)</span>                                               
#&gt; <span style="color: #525252;">2. </span>base::<span style="font-weight: bold;">stop</span><span style="color: #cc9900;">(</span><span style="font-weight: bold;">packageNotFoundError</span><span style="color: #B58900;">(</span>package, lib.loc, <span style="font-weight: bold;">sys.call</span><span style="color: #268BD2;">()</span><span style="color: #B58900;">)</span><span style="color: #cc9900;">)</span>               
#&gt; <span style="color: #525252;">3. </span>global (function (e) …                                                       
</pre>
</div>
<p>Errors from a <code>$call()</code> are returned in the
<code>error</code> entry of the result:</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span><span class="op">$</span><span class="fu">call</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st">"still-not"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">rs</span><span class="op">$</span><span class="fu">poll_process</span><span class="op">(</span><span class="fl">2000</span><span class="op">)</span></span>
<span><span class="va">rs</span><span class="op">$</span><span class="fu">read</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; [1] "ready"                                                                     
#&gt; $code                                                                           
#&gt; [1] 200                                                                         
#&gt;                                                                                 
#&gt; $message                                                                        
#&gt; [1] "done callr-rs-result-26cc123aeb62"                                         
#&gt;                                                                                 
#&gt; $result                                                                         
#&gt; NULL                                                                            
#&gt;                                                                                 
#&gt; $stdout                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $stderr                                                                         
#&gt; [1] ""                                                                          
#&gt;                                                                                 
#&gt; $error                                                                          
#&gt; <span style="color: #268BD2;">&lt;callr_error/rlib_error_3_0/rlib_error/error&gt;</span>                                   
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span>:                                                                          
#&gt; <span style="color: #B58900;">!</span> in callr subprocess.                                                          
#&gt; <span style="font-weight: bold;">Caused by error</span> in `library("still-not")`:                                      
#&gt; <span style="color: #B58900;">!</span> there is no package called ‘still-not’                                        
#&gt; ---                                                                             
#&gt; Subprocess backtrace:                                                           
#&gt; <span style="color: #525252;">1. </span>base::<span style="font-weight: bold;">library</span><span style="color: #cc9900;">(</span><span style="color: #009999;">"still-not"</span><span style="color: #cc9900;">)</span>                                                   
#&gt; <span style="color: #525252;">2. </span>base::<span style="font-weight: bold;">stop</span><span style="color: #cc9900;">(</span><span style="font-weight: bold;">packageNotFoundError</span><span style="color: #B58900;">(</span>package, lib.loc, <span style="font-weight: bold;">sys.call</span><span style="color: #268BD2;">()</span><span style="color: #B58900;">)</span><span style="color: #cc9900;">)</span>               
#&gt; <span style="color: #525252;">3. </span>global (function (e) …                                                       
#&gt;                                                                                 
#&gt; attr(,"class")                                                                  
#&gt; [1] "callr_session_result"                                                      
</pre>
</div>
</div>
<div class="section level2">
<h2 id="debugging">Debugging<a class="anchor" aria-label="anchor" href="#debugging"></a>
</h2>
<p>Debugging subprocesses is hard. <code>r_session</code> objects have a
couple of methods to help you, but it is still hard.</p>
<div class="section level3">
<h3 id="stack-traces">Stack traces<a class="anchor" aria-label="anchor" href="#stack-traces"></a>
</h3>
<p>As you have seen above, callr returns stack traces for errors, both
for the main process and the subprocess. If your packages are installed
with source references, then these include links to the source files as
well.</p>
</div>
<div class="section level3">
<h3 id="last-error">
<code>.Last.error</code><a class="anchor" aria-label="anchor" href="#last-error"></a>
</h3>
<p>For errors that are re-thrown in the main process, callr sets the
<code>.Last.error</code> variable to the last error object. You can
inspect that after the error.</p>
<p><code>.Last.error$parent</code> contains the error object from the
subprocess. The error object often has additional information about the
error, e.g. <code><a href="http://processx.r-lib.org/reference/run.html" class="external-link">processx::run()</a></code> includes the standard output +
error if the system process exits with a non-successful status:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rs</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">processx</span><span class="fu">::</span><span class="fu"><a href="http://processx.r-lib.org/reference/run.html" class="external-link">run</a></span><span class="op">(</span><span class="st">"ls"</span>, <span class="st">"/not-this"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span>:                                                                          
#&gt; <span style="color: #B58900;">!</span> in callr subprocess.                                                          
#&gt; <span style="font-weight: bold;">Caused by error</span> in `processx::run("ls", "/not-this")`:                          
#&gt; <span style="color: #B58900;">!</span> System command 'ls' failed                                                    
#&gt; <span style="color: #525252;">Type .Last.error to see the more details.</span>                                       
</pre>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.Last.error</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; <span style="color: #268BD2;">&lt;callr_error/rlib_error_3_0/rlib_error/error&gt;</span>                                   
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span>:                                                                          
#&gt; <span style="color: #B58900;">!</span> in callr subprocess.                                                          
#&gt; <span style="font-weight: bold;">Caused by error</span> in `processx::run("ls", "/not-this")`:                          
#&gt; <span style="color: #B58900;">!</span> System command 'ls' failed                                                    
#&gt; ---                                                                             
#&gt; Backtrace:                                                                      
#&gt; <span style="color: #525252;">1. </span>rs<span style="color: #cc9900;">$</span><span style="font-weight: bold;">run</span><span style="color: #cc9900;">(</span><span style="color: #999900;">function</span><span style="color: #B58900;">()</span> processx::<span style="font-weight: bold;">run</span><span style="color: #B58900;">(</span><span style="color: #009999;">"ls"</span>, <span style="color: #009999;">"/not-this"</span><span style="color: #B58900;">)</span><span style="color: #cc9900;">)</span>                          
#&gt; <span style="color: #525252;">2. </span>callr:::<span style="font-weight: bold;">rs_run</span><span style="color: #cc9900;">(</span>self, private, func, args, package<span style="color: #cc9900;">)</span>                           
#&gt; <span style="color: #525252;">3. </span>callr:::<span style="font-weight: bold;">throw</span><span style="color: #cc9900;">(</span>res<span style="color: #cc9900;">$</span>error<span style="color: #cc9900;">)</span>                                                     
#&gt; ---                                                                             
#&gt; Subprocess backtrace:                                                           
#&gt; <span style="color: #525252;">1. </span>processx::<span style="font-weight: bold;">run</span><span style="color: #cc9900;">(</span><span style="color: #009999;">"ls"</span>, <span style="color: #009999;">"/not-this"</span><span style="color: #cc9900;">)</span>                                             
#&gt; <span style="color: #525252;">2. </span>base::throw(new_process_error(res, call = sys.call(), echo = echo, …         
#&gt; <span style="color: #525252;">3. | base::signalCondition(cond)</span>                                                
#&gt; <span style="color: #525252;">4. </span>global (function (e) …                                                       
</pre>
</div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">.Last.error</span><span class="op">$</span><span class="va">parent</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; <span style="color: #268BD2;">&lt;system_command_status_error/rlib_error_3_0/rlib_error/error&gt;</span>                   
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span> in `processx::run("ls", "/not-this")`:                                    
#&gt; <span style="color: #B58900;">!</span> System command 'ls' failed                                                    
#&gt; ---                                                                             
#&gt; Exit status: 2                                                                  
#&gt; Stderr:                                                                         
#&gt; ls: cannot access '/not-this': No such file or directory                        
</pre>
</div>
</div>
<div class="section level3">
<h3 id="inspecting-the-stack-traces">Inspecting the stack traces<a class="anchor" aria-label="anchor" href="#inspecting-the-stack-traces"></a>
</h3>
<p>Another way to inspect the stack trace in the subprocess is to set
the <code>callr.traceback</code> option to <code>TRUE</code> and call
the <code>$traceback()</code> method after the error.</p>
<p>This option is off by default, because the stack trace sometimes
contains large objects, that take a lot of time to copy between
processes.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>callr.traceback <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/options.html" class="external-link">options</a></span><span class="op">(</span>warn <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>         <span class="co"># convert warnings to errors</span></span>
<span>  <span class="va">f1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">f2</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">f2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="fu">f3</span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">f3</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vec</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">vec</span><span class="op">)</span> <span class="st">"success"</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu">f1</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">rs</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="va">fun</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; <span style="font-weight: bold;color: #B58900;">Error</span>:                                                                          
#&gt; <span style="color: #B58900;">!</span> in callr subprocess.                                                          
#&gt; <span style="font-weight: bold;">Caused by error</span> in `if (vec) "success"`:                                        
#&gt; <span style="color: #B58900;">!</span> the condition has length &gt; 1                                                  
#&gt; <span style="color: #525252;">Type .Last.error to see the more details.</span>                                       
</pre>
</div>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span><span class="op">$</span><span class="fu">traceback</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; 3: f3() at #4                                                                   
#&gt; 2: f2() at #3                                                                   
#&gt; 1: f1()                                                                         
</pre>
</div>
</div>
<div class="section level3">
<h3 id="inspecting-frames-of-a-stack-trace">Inspecting frames of a stack trace<a class="anchor" aria-label="anchor" href="#inspecting-frames-of-a-stack-trace"></a>
</h3>
<p>If the <code>callr.traceback</code> option is <code>TRUE</code>, then
callr saves the full trace, including the frames. You can then inspect
these frames with the <code>$debug()</code> method. We can use it here
to debug the previous error:</p>
<p><img src="r-session_files/figure-html/debug.svg" width="100%"></p>
</div>
<div class="section level3">
<h3 id="interactive-debugging">Interactive debugging<a class="anchor" aria-label="anchor" href="#interactive-debugging"></a>
</h3>
<p>You can use the <code>$attach</code> method to start a REPL
(read-eval-print loop) that runs in the subprocess. It is best to do
this when the subprocess is idle, otherwise it is probably not
responsive.</p>
<p>Press CTRL+C or ESC, or type <code>.q</code> and press ENTER to quit
the REPL.</p>
<p>Here is an example:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">rs</span> <span class="op">&lt;-</span> <span class="va"><a href="../reference/r_session.html">r_session</a></span><span class="op">$</span><span class="fu">new</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">rs</span><span class="op">$</span><span class="fu">run</span><span class="op">(</span><span class="kw">function</span><span class="op">(</span><span class="op">)</span> <span class="op">{</span> <span class="va">.GlobalEnv</span><span class="op">$</span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">mtcars</span>; <span class="cn">NULL</span> <span class="op">}</span><span class="op">)</span></span></code></pre></div>
<div class="asciicast" style="color: #172431;font-family: 'Fira Code',Monaco,Consolas,Menlo,'Bitstream Vera Sans Mono','Powerline Symbols',monospace;line-height: 1.300000">
<pre>
#&gt; NULL                                                                            
</pre>
</div>
<p><img src="r-session_files/figure-html/attach-1.svg" width="100%"></p>
<p>This is an experimental feature and it does not always print the
output properly, e.g. sometimes you need to press ENTER twice, but
nevertheless it can be useful at times.</p>
</div>
</div>
<div class="section level2">
<h2 id="communication-protocol">Communication protocol<a class="anchor" aria-label="anchor" href="#communication-protocol"></a>
</h2>
<p>The <code>$read()</code> method can return messages with the
following <code>code</code>s:</p>
<ul>
<li>
<code>200</code>: the function is done. Note that the result might
still be an error, you need to check that the <code>error</code> entry
is not <code>NULL</code>.</li>
<li>
<code>201</code>: the R process is ready to use. This is the first
message you get after a successful non-blocking startup.</li>
<li>
<code>202</code>: attach is done. This is used internally by the
<code>$attach()</code> method, see the section about debugging
below.</li>
<li>
<code>301</code>: message from the subprocess. E.g. the cli package
can generate such messages, see <a href="https://cli.r-lib.org/articles/semantic-cli.html#sub-processes" class="external-link">the
cli documentation</a>.</li>
<li>
<code>500</code>: the R session exited cleanly. This means that the
evaluated expression quit R.</li>
<li>
<code>501</code>: the R session crashed or was killed.</li>
<li>
<code>502</code>: the R session closed its end of the connection
that callr uses for communication. This might also happen because it was
killed or crashed.</li>
</ul>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/gaborcsardi" class="external-link">Gábor Csárdi</a>, <a href="https://github.com/wch" class="external-link">Winston Chang</a>, <a href="https://www.posit.co" class="external-link"><img src="https://www.tidyverse.org/posit-logo.svg" alt="Posit" height="16" width="62" style="margin-bottom: 3px;"></a>, Ascent Digital Services.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
